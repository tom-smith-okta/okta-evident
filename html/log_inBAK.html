<html>

<head>

<title>Okta + Evident - log in</title>

<!-- javascript -->

<!-- jquery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- bootstrap -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

<!-- okta login widget -->
<script
  src="https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/2.14.0/js/okta-sign-in.min.js"
  type="text/javascript"></script>


<!-- okta authn sdk -->
<script src="https://ok1static.oktacdn.com/assets/js/sdk/okta-auth-js/2.0.1/okta-auth-js.min.js" type="text/javascript"></script>


<!-- css -->

<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" type="text/css">

<link href="https://getbootstrap.com/docs/4.2/examples/starter-template/starter-template.css" rel="stylesheet" type="text/css">

<link
  href="https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/2.14.0/css/okta-sign-in.min.css"
  type="text/css"
  rel="stylesheet"/>

</head>

<body>

<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
  <a class="navbar-brand" href="/">Atko Health</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarsExampleDefault">
    <ul class="navbar-nav mr-auto">

      <li class="nav-item active">
        <a class="nav-link" href="/">Home</span></a>
      </li>

    </ul>
  </div>
</nav>

<main role="main" class="container">
  <div class="starter-template">

    <div id = "widget-container"></div>

  </div>
</main>

<script>

// var signIn = new OktaSignIn({baseUrl: '{{OKTA_TENANT}}'})

// signIn.renderEl({
//   el: '#widget-container'
// }, function success(res) {
//   if (res.status === 'SUCCESS') {
//     res.session.setCookieAndRedirect('{{APP_HOME}}');

//   } else {
//     console.log("Could not log the user in.")

//     console.dir(res)

//   }
// })

var config = {
  // The URL for your Okta organization
  url: '{{OKTA_TENANT}}',
  clientId: '{{CLIENT_ID}}',
  redirectUri: '{{REDIRECT_URI}}',
  tokenManager: {
    storage: 'sessionStorage'
  }
}

var authClient = new OktaAuth(config)

authClient.tokenManager.get('idToken')
.then(function(token) {
  if (token) {
    // Token is valid
    console.log(token);
  } else {
    console.log("the token has expired.")

    var sessionToken = "{{sessionToken}}"


    if (sessionToken != "{{sessionToken}}") {

      authClient.token.getWithoutPrompt({
        sessionToken: '',
        scopes: [
          'openid',
          'email',
          'profile'
        ],
        state: '8rFzn3MH5q',
        nonce: '51GePTswrm',
        // Use a custom IdP for social authentication
        // idp: '0oa62b57p7c8PaGpU0h7'
       })
      .then(function(tokenOrTokens) {

        console.log("got a token")
        // manage token or tokens
      })
      .catch(function(err) {
        console.dir(err)
        // handle OAuthError
      });
    }
  }
})
.catch(function(err) {
  // OAuth Error
  console.error(err);
});


var signIn = new OktaSignIn({
  baseUrl: '{{OKTA_TENANT}}',
  clientId: '{{CLIENT_ID}}',
  redirectUri: '{{REDIRECT_URI}}',
  authParams: {
    // issuer: 'default',
    // responseType: ['id_token','token'],
    responseType: 'id_token',

    display: 'page'
  }
});

var sessionToken = "sometoken"



// signIn.showSignInToGetTokens({
//   clientId: '{{myClientId}}',
//   redirectUri: '{{redirectUri configured in OIDC app}}',

//   // Return an access token from the authorization server
//   getAccessToken: true,

//   // Return an ID token from the authorization server
//   getIdToken: true,

//   scope: 'openid profile'
// });



if (!signIn.token.hasTokensInUrl()) {
  signIn.renderEl({el: '#widget-container'},
    function() {},
    function(err) { console.err(err) });
}

else {
  signIn.token.parseTokensFromUrl(
    function success(res) {
      // Add the token to tokenManager to automatically renew the token when needed
      signIn.tokenManager.add('id_token', res[0]);
      signIn.tokenManager.add('access_token', res[1]);

      console.dir(res)
    },
    function error(err) {
      console.log('handle error', err);
    }
  );
}

</script>

</body>

</html>